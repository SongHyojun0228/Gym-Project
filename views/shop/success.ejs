<!DOCTYPE html>
<html lang="ko">
  <head>
    <link rel="stylesheet" href="/styles/toss.css" />
    <%- include("../includes/head") %>
    <link rel="stylesheet" href="/styles/after-purchase.css" />
  </head>
  <body>
    <%- include("../includes/header") %> <%- include('../includes/aside')%>
    <main>
      <h2>ê²°ì œ ì„±ê³µ</h2>
      <p id="paymentKey"></p>
      <p id="orderId"></p>
      <p id="amount"></p>
      <a href="/" id="go-to-home">í™ˆìœ¼ë¡œ</a>
    </main>
    <%- include("../includes/footer") %>
  </body>
</html>
<script>
  // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì´ ê²°ì œ ìš”ì²­í•  ë•Œ ë³´ë‚¸ ë°ì´í„°ì™€ ë™ì¼í•œì§€ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê²°ì œ ê¸ˆì•¡ì„ ì¡°ì‘í•˜ëŠ” í–‰ìœ„ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  const urlParams = new URLSearchParams(window.location.search);
  const paymentKey = urlParams.get("paymentKey");
  const orderId = urlParams.get("orderId");
  const amount = urlParams.get("amount");

  async function confirm() {
    const customerAddress = localStorage.getItem("user_address");
    const customerPhone = localStorage.getItem("user_phone");

    const requestData = {
      paymentKey: paymentKey,
      orderId: orderId,
      amount: amount,
      address: customerAddress,
      phone: customerPhone,
    };

    console.log("ğŸ“Œ ì„œë²„ë¡œ ë³´ë‚¼ ê²°ì œ ë°ì´í„°:", requestData);

    const response = await fetch("/confirm", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(requestData),
    });

    const json = await response.json();

    if (!response.ok) {
      // ê²°ì œ ì‹¤íŒ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
      console.log(json);
      window.location.href = `/fail?message=${json.message}&code=${json.code}`;
      return;
    }

    // ê²°ì œ ì„±ê³µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
    console.log("âœ… ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:", json);

    // âœ… ê²°ì œ ì •ë³´ë¥¼ DBì— ì €ì¥í•˜ëŠ” ìš”ì²­ ì¶”ê°€
    await fetch("/payment-success", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(requestData),
    });

    localStorage.removeItem("user_address");
    localStorage.removeItem("user_phone");

    console.log("âœ… ê²°ì œ ì •ë³´ ì €ì¥ ìš”ì²­ ì™„ë£Œ");
  }

  confirm();

  const paymentKeyElement = document.getElementById("paymentKey");
  const orderIdElement = document.getElementById("orderId");
  const amountElement = document.getElementById("amount");

  orderIdElement.textContent = "ì£¼ë¬¸ë²ˆí˜¸: " + orderId;
  amountElement.textContent = "ì´ ê²°ì œ ê¸ˆì•¡: " + amount.toLocaleString() + "ì›";
  paymentKeyElement.textContent = "paymentKey: " + paymentKey;
</script>
